package alex.veit.bookreadingstats;

import java.util.ArrayList;

import android.os.Parcel;
import android.os.Parcelable;

public class BookStats implements Parcelable {

	public static final String _CLASS = "BookStats";
	
	public static final Parcelable.Creator<BookStats> CREATOR = new Parcelable.Creator<BookStats>() {
		@Override
		public BookStats createFromParcel(final Parcel in) {
			return new BookStats(in);
		}

		@Override
		public BookStats[] newArray(final int size) {
			return new BookStats[size];
		}
	};
	boolean _hasNewSessions;
	
	boolean _alertNewSessions;
	boolean _alertBook;
	long _id;
	int _lastSession;
	String _name;
	boolean _needsUpdate;
	int _pagesRed;
	ArrayList<Session> _sessions;
	ArrayList<Session> _deletedSessions;
	int _totalPages;

	public BookStats() {
		this._sessions = new ArrayList<Session>();
		this._deletedSessions = new ArrayList<Session>();
		this._name = "";
		this._id = -1;
		this._lastSession = 1;
		this._totalPages = 0;
		this._pagesRed = 0;
		this._hasNewSessions = false;
		this._alertNewSessions = false;
		this._needsUpdate = false;
		this._alertBook = false;
	}

	public BookStats(final BookStats bs) {
		this._alertBook = bs._alertBook;
		this._alertNewSessions = bs._alertNewSessions;
		this._hasNewSessions = bs._hasNewSessions;
		this._id = bs._id;
		this._lastSession = bs._lastSession;
		this._name = bs._name;
		this._needsUpdate = bs._needsUpdate;
		this._pagesRed = bs._pagesRed;
		this._totalPages = bs._totalPages;
		this._sessions = new ArrayList<Session>(bs._sessions);
		this._deletedSessions = new ArrayList<Session>(bs._deletedSessions);
	}

	public BookStats(final Parcel in) {

		this();
		final int[] intData = new int[3];
		final boolean[] hasNew = new boolean[4];

		this._id = in.readLong();
		in.readIntArray(intData);
		this._totalPages = intData[0];
		this._pagesRed = intData[1];
		this._lastSession = intData[2];
		in.readTypedList(this._sessions, Session.CREATOR);
		in.readTypedList(this._deletedSessions, Session.CREATOR);
		this._name = in.readString();
		in.readBooleanArray(hasNew);
		this._hasNewSessions = hasNew[0];
		this._needsUpdate = hasNew[1];
		this._alertNewSessions = hasNew[2];
		this._alertBook = hasNew[3];

	}

	public boolean addSession(final long elapsedMillis) {
		if (elapsedMillis >= 60) {
			int hour = 0, minute = 0;
			String sHour = "", sMinute = "";
			long elapsedSeconds = elapsedMillis;
			do
				if (elapsedSeconds >= 60) {
					minute++;
					elapsedSeconds -= 60;
				}
			while (elapsedSeconds >= 60);

			do
				if (minute >= 60) {
					hour++;
					minute -= 60;
				}
			while (minute >= 60);

			if (hour < 10)
				sHour = "0" + hour;
			else
				sHour = Integer.toString(hour);

			if (minute < 10)
				sMinute = "0" + minute;
			else
				sMinute = Long.toString(minute);

			final Session ses = new Session(-1, "Session #" + this._lastSession
					+ " - " + sHour + ":" + sMinute, hour, minute);
			this._sessions.add(ses);
			this._lastSession++;
			this.updateBooleans();

			return true;
		}
		return false;

	}

	public boolean addSession(final String string) {
		if (string.length() == 4) {
			final int minute = Integer.parseInt(string.substring(2, 4));
			if (minute < 60) {
				final int hour = Integer.parseInt(string.substring(0, 2));
				final Session ses = new Session(-1, "Session #"
						+ this._lastSession + " - " + string.substring(0, 2)
						+ ":" + string.substring(2, 4), hour, minute);
				this._sessions.add(ses);
				this._lastSession++;
				this.updateBooleans();

				return true;
			}
		}
		return false;
	}

	public int addSession(final String sh, final String sm) {

		int testMin, testHour;

		if (!sm.isEmpty())
			testMin = Integer.parseInt(sm);
		else
			testMin = 0;

		if (!sh.isEmpty())
			testHour = Integer.parseInt(sh);
		else
			testHour = 0;

		if ((testHour == 0) && (testMin == 0))
			return -1;

		if (testMin < 60) {

			String sHour, sMinute;
			if (testHour < 10)
				sHour = "0" + testHour;
			else
				sHour = Integer.toString(testHour);

			if (testMin < 10)
				sMinute = "0" + testMin;
			else
				sMinute = Long.toString(testMin);

			final Session ses = new Session(-1, "Session #" + this._lastSession
					+ " - " + sHour + ":" + sMinute, testHour, testMin);
			this._sessions.add(ses);

			this._lastSession++;
			this.updateBooleans();

			return 1;
		}
		return -2;

	}

	public void deleteSes(final int thisID) {
		if (this._sessions.get(thisID)._id != -1)
			this._deletedSessions.add(this._sessions.get(thisID));
		this._sessions.remove(thisID);
		this.updateBooleans();

	}

	@Override
	public int describeContents() {
		// TODO Auto-generated method stub
		return 0;
	}

	protected int[] EstimatedReadTimeBundle() {

		double estimate = this.EstimatedReadTimeDouble();

		int hours = 0, minutes = 0;

		do
			if (estimate >= 60) {
				hours++;
				estimate -= 60;
			}
		while (estimate >= 60);

		minutes = (int) estimate;

		return new int[] { hours, minutes };
	}

	protected double EstimatedReadTimeDouble() {
		double estimate;

		if (this._pagesRed != 0)
			estimate = (double) (this.getElapsedInt() * this._totalPages)
					/ (double) this._pagesRed;
		else
			estimate = 0;
		return estimate;
	}

	public String getDoublePercentageString() {
		if (this._totalPages != 0)
			return Double.toString((double) (this._pagesRed * 100)
					/ this._totalPages);
		else
			return "0";
	}

	protected int getElapsedInt() {
		int hours = 0, minutes = 0;
		for (int i = 0; i < this._sessions.size(); i++) {
			hours += this._sessions.get(i)._hours;
			minutes += this._sessions.get(i)._minutes;
		}
		return (hours * 60) + minutes;
	}

	public String getElapsedTimeString() {
		String minutes;
		String hours;
		final int min = this.getLastMinutes();
		final int hour = this.getHours();
		if (min < 10)
			minutes = "0" + min;
		else
			minutes = Integer.toString(min);
		if (hour < 10)
			hours = "0" + hour;
		else
			hours = Integer.toString(hour);
		return hours + ":" + minutes;
	}

	public String getEstimatedReadTimeString() {

		final int[] time = this.EstimatedReadTimeBundle();
		final int hours = time[0], minutes = time[1];
		String h = "00", m = "00";

		if (hours < 10)
			h = "0" + hours;
		else
			h = Integer.toString(hours);

		if (minutes < 10)
			m = "0" + minutes;
		else
			m = Integer.toString(minutes);
		return h + ":" + m;
	}

	public String getEstimatedTimeLeftString() {

		String h = "00", m = "00";
		final int elapsed = this.getElapsedInt();
		final double estimated = this.EstimatedReadTimeDouble();

		int left = (int) (estimated - elapsed);

		int hours = 0, minutes = 0;

		if (!(left < 0)) {
			do
				if (left >= 60) {
					hours++;
					left -= 60;
				}
			while (left >= 60);

			minutes = left;

			if (hours < 10)
				h = "0" + hours;
			else
				h = Integer.toString(hours);

			if (minutes < 10)
				m = "0" + minutes;
			else
				m = Integer.toString(minutes);
		}

		return h + ":" + m;
	}

	private int getHours() {
		int hours = 0;
		int minutes = this.getTotalMinutes();
		for (int i = 0; i < this._sessions.size(); i++)
			hours += this._sessions.get(i)._hours;
		do
			if (minutes >= 60) {
				hours++;
				minutes -= 60;
			}
		while (minutes >= 60);
		return hours;
	}

	public String getIntPercentageString() {
		if (this._totalPages != 0)
			return Integer.toString((this._pagesRed * 100) / this._totalPages);
		else
			return "0";
	}

	private int getLastMinutes() {
		int minutes = 0;
		for (int i = 0; i < this._sessions.size(); i++)
			minutes += this._sessions.get(i)._minutes;
		do
			if (minutes >= 60)
				minutes -= 60;
		while (minutes >= 60);
		return minutes;
	}

	private int getTotalMinutes() {
		int minutes = 0;
		for (int i = 0; i < this._sessions.size(); i++)
			minutes += this._sessions.get(i)._minutes;
		return minutes;
	}

	@Override
	public String toString() {
		return this._name;
	}

	private void updateBooleans() {
		this._hasNewSessions = true;
		this._needsUpdate = true;
		this._alertNewSessions = true;
		this._alertBook = true;
	}

	@Override
	public void writeToParcel(final Parcel dest, final int flags) {
		// TODO Auto-generated method stub
		dest.writeLong(this._id);
		dest.writeIntArray(new int[] { this._totalPages, this._pagesRed,
				this._lastSession });
		dest.writeTypedList(this._sessions);
		dest.writeTypedList(this._deletedSessions);
		dest.writeString(this._name);
		dest.writeBooleanArray(new boolean[] { this._hasNewSessions,
				this._needsUpdate, this._alertNewSessions, this._alertBook });
	}
}
